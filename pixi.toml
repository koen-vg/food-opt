# SPDX-FileCopyrightText: 2025 Koen van Greevenbroek
#
# SPDX-License-Identifier: CC-BY-4.0

[workspace]
name = "food-opt"
version = "0.1.0"
description = "Global food systems optimization model combining environmental and nutritional needs"
channels = ["conda-forge"]
platforms = ["linux-64"]

[environments]
default = { solve-group = "default" }
dev = { features = ["dev"], solve-group = "default" }
gurobi = { features = ["gurobi"], solve-group = "default" }
dev-gurobi = { features = ["dev", "gurobi"], solve-group = "default" }

[dependencies]
# Core
python = ">=3.13.9,<3.14"

# Scientific computing
numpy = ">=2.3.5,<3"                 # Numerical arrays and computations
pandas = ">=2.3.3,<3"                # Data frames and tabular data
scikit-learn = ">=1.7.2,<2"          # Clustering for region aggregation

# Visualization
matplotlib = ">=3.10.8,<4"           # Plotting library
cartopy = ">=0.25.0,<0.26"           # Map projections and geospatial plotting
graphviz = ">=14.0.4,<15"            # Graph rendering (provides dot command for workflow diagrams)
python-graphviz = ">=0.21,<0.22"      # Python interface to Graphviz

# Geospatial data processing
geopandas = ">=1.1.1,<2"             # Spatial data frames
shapely = ">=2.1.2,<3"               # Geometric operations
rasterio = ">=1.4.3,<2"              # Raster data I/O
gdal = ">=3.10.3,<4"                 # Geospatial data abstraction library (provides ogr2ogr)
libgdal-netcdf = ">=3.10.3,<4"       # GDAL netCDF driver plugin

# File format support
openpyxl = ">=3.1.5,<4"              # Excel (.xlsx) file support
xlrd = ">=2.0.2,<3"                  # Excel (.xls) file support

# Data retrieval
requests = ">=2.32.5,<3"             # HTTP requests for downloading data
pycountry = ">=24.6.1,<25"           # ISO country codes and mappings

# System tools
curl = ">=8.17.0,<9"                 # HTTP downloads in workflow rules
p7zip = ">=16.02,<17"                # 7z archive extraction for Huang water data

[pypi-dependencies]
# Workflow engine
snakemake = ">=9.13.7, <10"

# Editable install of workflow package for cross-script imports
food-opt-workflow = { path = ".", editable = true }

# Optimization and modeling; own branches of pypsa and linopy with custom features needed by food-opt
pypsa = { git = "https://github.com/koen-vg/PyPSA.git", tag = "v1.0.6+food.opt" }
linopy = { git = "https://github.com/koen-vg/linopy.git", tag = "v0.5.7+food.opt" }

# Geospatial processing
exactextract = ">=0.2.2, <0.3"       # Fast zonal statistics from rasters

# Data retrieval
faostat = ">=1.1.2, <2"              # FAO statistics API client
ecmwf-datastores-client = ">=0.4.1, <0.5" # ECMWF climate data access
gsutil = ">=5.35, <6"                # Google Cloud Storage CLI

# Validation
pandera = ">=0.27.0, <0.28"
pydantic = ">=2.12.4, <3"

[feature.gurobi.pypi-dependencies]
gurobipy = ">=13.0.0, <14"           # Gurobi commercial MILP solver (requires license)

[feature.dev.dependencies]
# Interactive development
jupyter = ">=1.1.1,<2"               # Jupyter notebook interface
ipython = ">=9.7.0,<10"              # Enhanced Python REPL

# Code quality
prek = ">=0.1.0,<2"                  # Git pre-commit hooks runner
ruff = ">=0.14.6,<0.15"              # Fast Python linter and formatter
nbstripout = ">=0.8,<1"              # Strip notebook outputs for clean git diffs

# Documentation
sphinx = ">=8.2.3,<9"                # Documentation generator
sphinx-autodoc-typehints = ">=3.5.2,<4" # Type hint support for Sphinx
furo = ">=2024.8.6,<2025"            # Clean Sphinx theme
pydot = ">=4.0.1,<5"                 # Python interface to Graphviz for workflow diagrams
make = ">=4.4,<5"                    # Build tool for Sphinx Makefile

[feature.dev.pypi-dependencies]
snakefmt = ">=0.11.2, <0.12"         # Snakemake code formatter

[tasks]
smk = { cmd = "tools/smk" }
lint = { cmd = "ruff check ." }
format = { cmd = "ruff format ." }

[feature.dev.tasks]
# Formatting tasks
format-snakemake = { cmd = "snakefmt workflow/" }
format-all = { depends-on = ["format", "format-snakemake"] }

# Documentation tasks
build-docs = { cmd = "tools/smk -j4 --configfile config/doc_figures.yaml -- build_docs" }
upload-doc-figures = { cmd = "tools/upload-doc-figures" }
update-figure-refs-remote = { cmd = "tools/update-figure-refs --to-remote" }
update-figure-refs-local = { cmd = "tools/update-figure-refs --to-local" }
docs-local = { cmd = "tools/update-figure-refs --to-local && sphinx-build -b html docs docs/_build/html" }
