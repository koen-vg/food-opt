#!/usr/bin/env bash
# SPDX-FileCopyrightText: 2025 Koen van Greevenbroek
#
# SPDX-License-Identifier: CC-BY-4.0

# Update figure references in documentation to use GitHub release URLs
# Usage: tools/update-figure-refs [--to-remote|--to-local]

set -euo pipefail

MODE="${1:---to-remote}"
DOCS_DIR="docs"
RELEASE_TAG="doc-figures"
GITHUB_REPO="Sustainable-Solutions-Lab/food-opt"
BASE_URL="https://github.com/${GITHUB_REPO}/releases/download/${RELEASE_TAG}"

if [ "$MODE" = "--to-remote" ]; then
    echo "Updating figure references to use GitHub release URLs..."

    # Find all .rst files and update figure paths
    find "$DOCS_DIR" -name "*.rst" -type f | while read -r rst_file; do
        # Skip if no figure references
        if ! grep -q "_static/figures/" "$rst_file" 2>/dev/null; then
            continue
        fi

        echo "  Processing: $rst_file"

        # Replace local paths with GitHub URLs
        # Handle both /_static/figures/ and _static/figures/ with or without leading space
        sed -i.bak \
            -e "s|/_static/figures/\([^[:space:]]*\.png\)|${BASE_URL}/\1|g" \
            -e "s|\([[:space:]]\)_static/figures/\([^[:space:]]*\.png\)|\1${BASE_URL}/\2|g" \
            "$rst_file"

        # Remove backup file
        rm "${rst_file}.bak"
    done

    echo "✓ Updated figure references to remote URLs"

elif [ "$MODE" = "--to-local" ]; then
    echo "Updating figure references to use local paths..."

    # Find all .rst files and update figure paths
    find "$DOCS_DIR" -name "*.rst" -type f | while read -r rst_file; do
        # Skip if no GitHub URLs
        if ! grep -q "${BASE_URL}" "$rst_file" 2>/dev/null; then
            continue
        fi

        echo "  Processing: $rst_file"

        # Replace GitHub URLs with local paths
        sed -i.bak \
            -e "s|${BASE_URL}/|_static/figures/|g" \
            "$rst_file"

        # Remove backup file
        rm "${rst_file}.bak"
    done

    echo "✓ Updated figure references to local paths"

else
    echo "Usage: tools/update-figure-refs [--to-remote|--to-local]"
    echo ""
    echo "  --to-remote  Update to use GitHub release URLs (default)"
    echo "  --to-local   Revert to local _static/figures/ paths"
    exit 1
fi
