# SPDX-FileCopyrightText: 2025 Koen van Greevenbroek
#
# SPDX-License-Identifier: GPL-3.0-or-later

import os
from pathlib import Path

from snakemake.utils import min_version

from validation import validate

min_version("9.0")

os.makedirs("data/downloads", exist_ok=True)


configfile: "config/default.yaml"


validate(config, project_root=Path.cwd())


# Include common configuration and helper functions first
include: "rules/common.smk"
include: "rules/retrieve.smk"
include: "rules/geography.smk"
include: "rules/health.smk"
include: "rules/animals.smk"
include: "rules/crops.smk"
include: "rules/water.smk"
include: "rules/model.smk"
include: "rules/plotting.smk"
include: "rules/yield_gaps.smk"
include: "rules/luc.smk"
include: "rules/documentation.smk"


wildcard_constraints:
    climate_model=r"[a-zA-Z0-9\-]+",
    period=r"[A-Z0-9]+",
    scenario=r"[A-Z0-9]+",
    input_level=r"H|L",
    water_supply=r"[ri]",
    crop=r"[a-zA-Z0-9\-]+",
    item=r"[a-zA-Z0-9_-]+",
    objective=r"[A-Z]*",  # Objective wildcard flags: H=health, G=GHG (e.g., HG, H, G, or empty for baseline)


ALL_RULE_TARGETS = [
    "results/{name}/solved/model_obj-HG.nc",
    # maps (not objective-specific, in base plots directory)
    "results/{name}/plots/regions_map.pdf",
    "results/{name}/plots/resource_classes_map.pdf",
    "results/{name}/plots/food_consumption_baseline_map.pdf",
    "results/{name}/plots/relative_risk_curves.pdf",
    # results plots
    "results/{name}/plots/obj-HG/crop_production.pdf",
    "results/{name}/plots/obj-HG/resource_usage.pdf",
    "results/{name}/plots/obj-HG/crop_production.csv",
    "results/{name}/plots/obj-HG/food_production.csv",
    "results/{name}/plots/obj-HG/consumption_balance.pdf",
    "results/{name}/plots/obj-HG/objective_breakdown.pdf",
    "results/{name}/plots/obj-HG/objective_breakdown.csv",
    "results/{name}/plots/obj-HG/emissions_breakdown.pdf",
    "results/{name}/plots/obj-HG/health_risk_map.pdf",
    "results/{name}/plots/obj-HG/health_risk_by_region.csv",
    "results/{name}/plots/obj-HG/health_baseline_map.pdf",
    "results/{name}/plots/obj-HG/health_baseline_by_region.csv",
    # objective-specific maps
    "results/{name}/plots/obj-HG/crop_production_map.pdf",
    "results/{name}/plots/obj-HG/crop_land_use_map.pdf",
    "results/{name}/plots/obj-HG/cropland_fraction_map.pdf",
    "results/{name}/plots/obj-HG/irrigated_cropland_fraction_map.pdf",
    "results/{name}/plots/obj-HG/crop_use_breakdown.pdf",
    "results/{name}/plots/obj-HG/crop_use_breakdown.csv",
    "results/{name}/plots/obj-HG/feed_breakdown.pdf",
    "results/{name}/plots/obj-HG/feed_breakdown.csv",
    "results/{name}/plots/obj-HG/food_group_slack.pdf",
    "results/{name}/plots/obj-HG/food_group_slack.csv",
    # "results/{name}/plots/obj-HG/water_value_map.pdf",   # Current not working
    "results/{name}/plots/obj-HG/food_consumption.pdf",
    "results/{name}/plots/obj-HG/food_consumption_map.pdf",
]


rule all:
    input:
        expand(ALL_RULE_TARGETS, name=[name]),
